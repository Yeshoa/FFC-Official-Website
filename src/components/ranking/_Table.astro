---
import { Image } from 'astro:assets';
import { getRankedMembers } from '@lib/rankingUtils';
import { getTotalColorClass } from '@lib/scoreUtils';
import { getCurrentEventPoints } from '@lib/eventUtils';
import { getCurrentBonusPoints } from '@lib/bonusUtils';
import { getCurrentRoleplayPoints } from '@lib/roleplayUtils';

const { members, currentTournamentId } = Astro.props;

// Calcular ranking
const rankedMembers = await getRankedMembers(members, currentTournamentId);
---

<div class="w-full">
  <h6 class="2xl:hidden text-center mb-2 opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.3s]">Swipe to see full scores</h6>
  
  <div class="overflow-x-auto rounded-lg opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.5s]">
    <table class="table-fixed border-collapse text-sm w-max mx-auto">
      <colgroup>
        <col style="width: 30px;"> <!-- Pos -->
        <col style="width: 30px;"> <!-- Flag -->
        <col style="width: 240px;"> <!-- Team -->
        <col style="width: 65px;"> <!-- Has Dispatch/History -->
        <col style="width: 65px;" > <!-- Has FC mentions in Dispatch -->
        <col style="width: 65px;"> <!-- Updated Roster -->
        <col style="width: 65px;"> <!-- Article -->
        <col style="width: 65px;"> <!-- Poetry -->
        <!-- <col style="width: 65px;"> --> <!-- Flag & Banner -->
        <col style="width: 65px;"> <!-- Murder Mystery -->
        <col style="width: 65px;"> <!-- Quiz -->
        <!-- <col style="width: 65px;"> --> <!-- Scavenger Hunt -->
        <col style="width: 65px;"> <!-- Forest-Themed Connections Grid -->
        <col style="width: 65px;"> <!-- Host -->
        <col style="width: 65px;"> <!-- Eggs -->
        <col style="width: 65px;"> <!-- Extra -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- RP -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Events -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Bonus -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Results -->
        <col style="width: 30px;"> <!-- Total -->
      </colgroup>
      
      <thead class="bg-green-800 uppercase">
        <tr>
          <th rowspan="2" class="px-2 py-3 text-center border-b border-green-600 rounded-tl-xl" title="Position">Â°</th>
          <th rowspan="2" class="px-5 py-3 text-center border-b border-green-600"></th>
          <th rowspan="2" class="py-3 text-left border-b border-green-600">Team</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Roleplay</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Events</th>
          <th colspan="3" class="px-4 py-2 text-center border-b border-l border-green-600">Bonus</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Past</th>
          <th rowspan="2" class="px-3 py-3 text-center font-bold border-b border-l border-green-600 rounded-tr-xl">Pts</th>
        </tr>
        <tr>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="History Points - Roleplay, lore, dispatches">Hist</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="FC Mentions - Mentions in dispatches">FCM</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Updated Roster - Updated roster for the current edition">UR</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Article Points">AR</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Poetry Fantasia Points">PF</th>
          <!-- <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Flag & Banner Points">F&B</th> -->
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Murder Mystery Points">MM</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Quiz Contest Points">Quiz</th>
          <!-- <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Scavenger Hunt Points">SH</th> -->
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Forest-Themed Connections Grid Points">CG</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Host advantage points">Host</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Flag & Banner Points">Eggs</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Extra contribution points">Extra</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Roleplay Points - Previous editions with decay">RP</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Event Points - Previous editions with decay">Events</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Bonus Points - Previous editions with decay">Bonus</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Previous Tournament Results - Automatic calculation with decay">Results</th>
        </tr>
      </thead>
      
      <tbody class="text-center text-green-300">
        {rankedMembers.map((team, index) => {
          const historyPoints = getCurrentRoleplayPoints(team, 'dispatch');
          const fcMentions = getCurrentRoleplayPoints(team, 'fcm');
          const updatedRoster = getCurrentRoleplayPoints(team, 'roster');
          const articlePoints = getCurrentRoleplayPoints(team, 'article');
          const poetryPoints = getCurrentEventPoints(team, 'poetry');
          const flagBannerPoints = getCurrentEventPoints(team, 'fb');
          const murderMysteryPoints = getCurrentEventPoints(team, 'mm');
          const quizPoints = getCurrentEventPoints(team, 'quiz');
          const scavengerHuntPoints = getCurrentEventPoints(team, 'sh');
          const connectionsGridPoints = getCurrentEventPoints(team, 'cg');
          const hostPoints = getCurrentBonusPoints(team, 'host');
          const eggsPoints = getCurrentBonusPoints(team, 'eggs');
          const extraPoints = getCurrentBonusPoints(team, 'extra');

          return (
          <tr class="border-b border-green-700 hover:bg-green-900/30 transition duration-150">
            <td class="py-2">{index + 1}</td>
            <td class="py-1 sticky left-0 bg-green-800 xl:bg-transparent">
              <Image 
                src={team.flag || "/placeholder.svg"} 
                alt={team.name} 
                quality={20} 
                format="webp"
                width={50} 
                class="h-4 w-auto object-cover rounded inline-block" 
              />
            </td>
            <td class="py-2 text-left overflow-hidden text-ellipsis">
              <a 
                href={`/members/${team.slug}`} 
                class="font-semibold hover:underline text-white overflow-hidden text-ellipsis ml-2" 
                title={team.name}
              >
                {team.name}
              </a>
            </td>
            
            <td class="px-2 py-2" title={`History Points: ${historyPoints}`}>
              {historyPoints}
            </td>
            <td class="px-2 py-2" title={`FC Mentions: ${fcMentions}`}>
              {fcMentions}
            </td>
            <td class="px-2 py-2" title={`Updated Roster: ${updatedRoster}`}>
              {updatedRoster}
            </td>
            <td class="px-2 py-2" title={`Article Points: ${articlePoints}`}>
              {articlePoints}
            </td>
            <td class="px-2 py-2" title={`Poetry Contest Points: ${poetryPoints}`}>
              {poetryPoints}
            </td>
            {/* <td class="px-2 py-2" title={`Flag & Banner Points: ${flagBannerPoints}`}>
              {flagBannerPoints}
            </td> */}
            <td class="px-2 py-2" title={`Murder Mystery Points: ${murderMysteryPoints}`}>
              {murderMysteryPoints}
            </td>
            <td class="px-2 py-2" title={`Quiz Points: ${quizPoints}`}>
              {quizPoints}
            </td>
            {/* <td class="px-2 py-2" title={`Scavenger Hunt Points: ${scavengerHuntPoints}`}>
              {scavengerHuntPoints}
            </td> */}
            <td class="px-2 py-2" title={`Connections Grid Points: ${connectionsGridPoints}`}>
              {connectionsGridPoints}
            </td>
            <td class="px-2 py-2" title={`Host Bonus: ${hostPoints}`}>
              {hostPoints}
            </td>
            <td class="px-2 py-2" title={`Eggs Points: ${eggsPoints}`}>
              {eggsPoints}
            </td>
            <td class="px-2 py-2" title={`Extra Bonus: ${extraPoints}`}>
              {extraPoints}
            </td>
            <td class="px-2 py-2" title={`Past Roleplay Points: ${team.scores.pastRoleplay}`}>
              {team.scores.pastRoleplay}
            </td>
            <td class="px-2 py-2" title={`Past Event Points: ${team.scores.pastEventPoints}`}>
              {team.scores.pastEventPoints}
            </td>
            <td class="px-2 py-2" title={`Past Bonus Points: ${team.scores.pastBonus}`}>
              {team.scores.pastBonus}
            </td>
            <td class="px-2 py-2" title={`Tournament Decay Points: ${team.scores.tournamentDecayPoints}`}>
              {team.scores.tournamentDecayPoints}
            </td>
            <td class={`px-4 py-2 ${getTotalColorClass(team.totalScore)}`}>
              {team.totalScore}
            </td>
          </tr>
        )})}
        
        {rankedMembers.length === 0 && (
          <tr>
            <td colspan="20" class="text-center py-4 text-green-500">
              No verified members found.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>
</div>