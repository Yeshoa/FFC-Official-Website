---
import { Image } from 'astro:assets';
import { getRankedMembers } from '@lib/rankingUtils';
import { getTotalColorClass } from '@lib/scoreUtils';
import { getCurrentBonusPoints } from '@lib/bonusUtils';
import { getEvents, getRoleplays } from '@lib/collections';
import { getCurrentEvents } from '@lib/eventUtils';
import { getCurrentRoleplays } from '@lib/roleplayUtils';

// const events = getEvents();
// const roleplays = getRoleplays();

const { members, currentTournamentId } = Astro.props;

// Calcular ranking
const rankedMembers = await getRankedMembers(members, currentTournamentId);

// Obtener todos los nombres de eventos y roleplays únicos
const currentEvents = getCurrentEvents();
const currentRoleplays = getCurrentRoleplays();

const headerCellClass = "px-2 py-2 text-center font-medium border-b border-l border-green-600";
---

<div class="w-full mb-6">
  <h6 class="2xl:hidden text-center mb-2 opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.3s]">
    Swipe to see full scores
  </h6>
  
  <div class="overflow-x-auto rounded-lg opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.5s]">
    <table class="table-fixed border-collapse text-sm w-max mx-auto">
      <colgroup>
        <col style="width: 30px;"> <!-- Pos -->
        <col style="width: 30px;"> <!-- Flag -->
        <col style="width: 240px;"> <!-- Team -->
        {currentRoleplays.map(() => <col style="width: 50px;">)}
        {currentEvents.map(() => <col style="width: 50px;">)}
        <col style="width: 65px;"> <!-- Host -->
        <col style="width: 65px;"> <!-- Eggs -->
        <col style="width: 65px;"> <!-- Extra -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Past RP -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Past Events -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Past Bonus -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Past Results -->
        <col style="width: 30px;"> <!-- Total -->
      </colgroup>
      
      <thead class="bg-green-800 uppercase">
        <tr>
          <th rowspan="2" class="px-2 py-3 text-center border-b border-green-600 rounded-tl-xl" title="Position">°</th>
          <th rowspan="2" class="px-5 py-3 text-center border-b border-green-600"></th>
          <th rowspan="2" class="py-3 text-left border-b border-green-600">Team</th>
          <th colspan={currentRoleplays.length} class="px-4 py-2 text-center border-b border-l border-green-600">Roleplay</th>
          <th colspan={currentEvents.length} class="px-4 py-2 text-center border-b border-l border-green-600">Events</th>
          <th colspan="3" class="px-4 py-2 text-center border-b border-l border-green-600">Bonus</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Past</th>
          <th rowspan="2" class="px-3 py-3 text-center font-bold border-b border-l border-green-600 rounded-tr-xl">Pts</th>
        </tr>
        <tr>
          {currentRoleplays.map(roleplay => (
            <th class={headerCellClass} title={`${roleplay.description}`}>
              {roleplay.code || roleplay.name.slice(0, 4)}
            </th>
          ))}
          {currentEvents.map(event => (
            <th class={headerCellClass} title={`${event.name} Points`}>
              {event.code || event.name.slice(0, 4)}
            </th>
          ))}
          <th class={headerCellClass} title="Host advantage points">Host</th>
          <th class={headerCellClass} title="Eggs Points">Eggs</th>
          <th class={headerCellClass} title="Extra contribution points">Extra</th>
          <th class={headerCellClass} title="Past Roleplay Points - Previous editions with decay">RP</th>
          <th class={headerCellClass} title="Past Event Points - Previous editions with decay">Events</th>
          <th class={headerCellClass} title="Past Bonus Points - Previous editions with decay">Bonus</th>
          <th class={headerCellClass} title="Previous Tournament Results - Automatic calculation with decay">Results</th>
        </tr>
      </thead>
      
      <tbody class="text-center text-green-300">
        {rankedMembers.map((team, index) => {
          const hostPoints = getCurrentBonusPoints(team, 'host');
          const eggsPoints = getCurrentBonusPoints(team, 'eggs');
          const extraPoints = getCurrentBonusPoints(team, 'extra');

          return (
            <tr class="border-b border-green-700 hover:bg-green-900/30 transition duration-150">
              <td class="py-2">{index + 1}</td>
              <td class="py-1 sticky left-0 bg-green-800 xl:bg-transparent">
                <Image 
                  src={team.flag || "/placeholder.svg"} 
                  alt={team.name} 
                  quality={20} 
                  format="webp"
                  width={50} 
                  class="h-4 w-auto object-cover rounded inline-block" 
                />
              </td>
              <td class="py-2 text-left overflow-hidden text-ellipsis">
                <a 
                  href={`/members/${team.slug}`} 
                  class="font-semibold hover:underline text-white overflow-hidden text-ellipsis ml-2" 
                  title={team.name}
                >
                  {team.name}
                </a>
              </td>
              
              {currentRoleplays.map(roleplay => (
                <td 
                  class="px-2 py-2" 
                  title={`${roleplay.name} Points: ${team.currentRoleplay[roleplay.name] || 0}`}
                >
                  {team.currentRoleplay[roleplay.name] || 0}
                </td>
              ))}

              {currentEvents.map(event => (
                <td 
                  class="px-2 py-2" 
                  title={`${event.name} Points: ${team.currentEvents[event.name] || 0}`}
                >
                  {team.currentEvents[event.name] || 0}
                </td>
              ))}
              <td class="px-2 py-2" title={`Host Bonus: ${hostPoints}`}>
                {hostPoints}
              </td>
              <td class="px-2 py-2" title={`Eggs Points: ${eggsPoints}`}>
                {eggsPoints}
              </td>
              <td class="px-2 py-2" title={`Extra Bonus: ${extraPoints}`}>
                {extraPoints}
              </td>
              <td class="px-2 py-2" title={`Past Roleplay Points: ${team.scores.pastRoleplay}`}>
                {team.scores.pastRoleplay}
              </td>
              <td class="px-2 py-2" title={`Past Event Points: ${team.scores.pastEventPoints}`}>
                {team.scores.pastEventPoints}
              </td>
              <td class="px-2 py-2" title={`Past Bonus Points: ${team.scores.pastBonus}`}>
                {team.scores.pastBonus}
              </td>
              <td class="px-2 py-2" title={`Tournament Decay Points: ${team.scores.tournamentDecayPoints}`}>
                {team.scores.tournamentDecayPoints}
              </td>
              <td class={`px-4 py-2 ${getTotalColorClass(team.totalScore)}`}>
                {team.totalScore}
              </td>
            </tr>
          )
        })}
        
        {rankedMembers.length === 0 && (
          <tr>
            <td colspan={12 + currentRoleplays.length + currentEvents.length} class="text-center py-4 text-green-500">
              No verified members found.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>
</div>