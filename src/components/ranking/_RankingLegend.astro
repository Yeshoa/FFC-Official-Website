---
import { Image } from 'astro:assets';
import { getRankedMembers } from '@lib/rankingUtils';
import { getTotalColorClass, SCORING_CONFIG } from '@lib/scoreUtils';
import { getCurrentEventPoints } from '@lib/eventUtils';
import { getCurrentBonusPoints } from '@lib/bonusUtils';
import { getCurrentRoleplayPoints } from '@lib/roleplayUtils';
import Arrow from '@images/icons/arrow-up-right-from-square-solid.svg';

const { members, tournaments, currentTournamentId } = Astro.props;

// Calcular ranking
const rankedMembers = await getRankedMembers(members, currentTournamentId);

// Calcular la próxima edición dinámicamente
const getNextEdition = () => {
  if (!tournaments || tournaments.length === 0) return 2026; // Fallback
  const maxEdition = Math.max(...tournaments.map(t => t.data.edition));
  return maxEdition;
};

const nextEdition = getNextEdition();
---

<div class="w-full p-6 items-center">
  <h1 class="text-6xl font-bold mb-6 text-center animate-sladeIn">Ranking</h1>
  <!-- <p class="text-lg mb-4 text-center opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.1s]">
    Score determines how strong your team will be. More points means higher chances to win.
  </p> -->

  <div class="max-w-7xl mx-auto bg-green-900/30 rounded-lg p-6 mb-7 opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.15s]">
    <div class="bg-green-800/20 rounded-lg p-2 mb-4">
      <p class="text-sm text-green-200 text-center">
        Your <strong>Total Score</strong> combines roleplay, events, bonuses, and past performance with decay. 
        <br>
        Higher scores mean higher chances to win, better seeding and direct qualification!
      </p>
      <div class="text-center mt-3">
        <a href="/articles/ranking" class="inline-flex items-center px-4 py-2 bg-green-700/50 hover:bg-green-600/50 text-green-200 rounded-lg transition-colors duration-200 text-sm font-medium">
          Read Full Detailed Explanation
        </a>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      
      <div class="bg-green-800/10 rounded-lg p-4">
        <h4 class="font-semibold text-green-300 mb-2 text-center">Roleplay</h4>
        
        <div class="space-y-2 text-sm text-green-200">
          <div class="flex justify-between items-center">
            <span><strong>Hist:</strong></span>
            <span class="text-xs text-green-400">{SCORING_CONFIG.RP_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-3">
            A NationStates dispatch covering team history, league creation, or football lore.
          </p>
          
          <div class="flex justify-between items-center">
            <span><strong>FCM:</strong></span>
            <span class="text-xs text-green-400">{SCORING_CONFIG.RP_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-3">
            Any roleplay about this edition of the Forest Cup, or a mention in your dispatch for this edition, either in text or results section.
          </p>

          <div class="flex justify-between items-center">
            <span><strong>UR:</strong></span>
            <span class="text-xs text-green-400">{SCORING_CONFIG.RP_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-3">
            Updated roster submission with current squad and formation for this edition.
          </p>

          <div class="flex justify-between items-center">
            <span><strong>AR:</strong></span>
            <span class="text-xs text-green-400">{SCORING_CONFIG.RP_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300">
            One article for the website about anything (football related of course). Additional articles do not accumulate points.
          </p>
        </div>
      </div>

      <div class="bg-green-800/10 rounded-lg p-4">
        <h4 class="font-semibold text-green-300 mb-2 text-center">Events</h4>
        
        <div class="space-y-2 text-sm text-green-200">
          <div class="flex justify-between items-center">
            <span><strong>PF:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            <a href="https://www.nationstates.net/page=dispatch/id=2664340" target="_blank" class="text-blue-300 hover:text-blue-200">Poetry Fantasia <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> contest points
          </p>
          
          <div class="flex justify-between items-center">
            <span><strong>FB:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            <a href="https://www.nationstates.net/page=rmb/postid=60040670" class="text-blue-300 hover:text-blue-200">Flag & Banner <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> design points
          </p>

          <div class="flex justify-between items-center">
            <span><strong>MM:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            <a href="https://www.nationstates.net/page=dispatch/id=2687574" class="text-blue-300 hover:text-blue-200">Murder Mystery <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> event points
          </p>

          <div class="flex justify-between items-center">
            <span><strong>Quiz:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            <a href="https://www.nationstates.net/page=rmb/postid=60040670" class="text-blue-300 hover:text-blue-200">Forest Quiz <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> points
          </p>

          <div class="flex justify-between items-center">
            <span><strong>SH:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            <a href="#" class="text-blue-300 hover:text-blue-200">Scavenger Hunt <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> challenge points
          </p>

          <div class="flex justify-between items-center">
            <span><strong>CG:</strong></span>
            <span class="text-xs text-green-400">Max {SCORING_CONFIG.EV_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300">
            <a href="https://www.nationstates.net/page=dispatch/id=2689546" class="text-blue-300 hover:text-blue-200">Forest Connections Grid <Arrow class="inline w-3 h-3 fill-blue-400 ml-1" /></a> puzzle points
          </p>
        </div>
      </div>

      <div class="bg-green-800/10 rounded-lg p-4">
        <h4 class="font-semibold text-green-300 mb-2 text-center">Bonus</h4>
        
        <div class="space-y-2 text-sm text-green-200">
          <div class="flex justify-between items-center">
            <span><strong>Host:</strong></span>
            <span class="text-xs text-green-400">{SCORING_CONFIG.BO_MAX} Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-3">
            {SCORING_CONFIG.BO_MAX} points for hosting a Forest Cup tournament edition.
          </p>
          
          <div class="flex justify-between items-center">
            <span><strong>Eggs:</strong></span>
            <span class="text-xs text-green-400">Max 20 Pts.</span>
          </div>
          <p class="text-xs text-green-300 mb-3">
            4 points per easter egg discovered throughout the edition.
          </p>

          <div class="flex justify-between items-center">
            <span><strong>Extra:</strong></span>
            <span class="text-xs text-green-400">Variable</span>
          </div>
          <p class="text-xs text-green-300">
            Variable points for exceptional contributions and dedication.
          </p>
        </div>
      </div>

      <div class="bg-green-800/10 rounded-lg p-4">
        <h4 class="font-semibold text-green-300 mb-2 text-center">Past Performance</h4>
        
        <div class="space-y-2 text-sm text-green-200">
          <div class="flex justify-between items-center">
            <span><strong>RP:</strong></span>
            <span class="text-xs text-green-400">Decay</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            Decayed roleplay points from previous editions
          </p>
          
          <div class="flex justify-between items-center">
            <span><strong>Events:</strong></span>
            <span class="text-xs text-green-400">Decay</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            Decayed event points from previous editions
          </p>

          <div class="flex justify-between items-center">
            <span><strong>Bonus:</strong></span>
            <span class="text-xs text-green-400">Decay</span>
          </div>
          <p class="text-xs text-green-300 mb-2">
            Decayed bonus points from previous editions
          </p>

          <div class="flex justify-between items-center">
            <span><strong>Results:</strong></span>
            <span class="text-xs text-green-400">Decay</span>
          </div>
          <p class="text-xs text-green-300">
            Decayed tournament performance points from previous editions
          </p>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-r from-green-800/20 to-blue-800/20 rounded-lg p-4">
      <h4 class="font-semibold text-green-300 mb-2 text-center">Understanding the Decay System</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <p class="text-green-200 mb-2">
            <strong>Purpose:</strong> Recent activity weighs more than ancient achievements. This keeps rankings dynamic and rewards current participation over old glory.
          </p>
          <p class="text-green-300 text-xs">
            <strong>Example:</strong> 10 points from last edition count as 10 points. 
            The same 10 points from two editions ago only count as 5 points (50% decay).
          </p>
        </div>
        <div class="text-center">
          <div class="inline-block bg-green-900/30 rounded-lg p-3">
            <div class="text-xs text-green-400 space-y-1">
              <div class="flex justify-between w-32">
                <span>Last edition:</span>
                <span class="text-green-300 font-bold">100%</span>
              </div>
              <div class="flex justify-between w-32">
                <span>2 editions ago:</span>
                <span class="text-yellow-300 font-bold">50%</span>
              </div>
              <div class="flex justify-between w-32">
                <span>3 editions ago:</span>
                <span class="text-orange-300 font-bold">25%</span>
              </div>
              <div class="flex justify-between w-32">
                <span>4 editions ago:</span>
                <span class="text-red-300 font-bold">10%</span>
              </div>
              <div class="flex justify-between w-32">
                <span>Older than 4:</span>
                <span class="text-gray-400 font-bold">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h6 class="2xl:hidden text-center mb-2 opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.3s]">Swipe to see full scores</h6>
  
  <div class="overflow-x-auto rounded-lg opacity-0 animate-[slide-in_1s_ease-in-out_forwards_.5s]">
    <!-- <table class="min-w-7xl table-fixed border-collapse text-sm w-max md:w-full max-w-7xl mx-auto"> -->
    <table class="table-fixed border-collapse text-sm w-max mx-auto">
      <colgroup>
        <col style="width: 30px;"> <!-- Pos -->
        <col style="width: 30px;"> <!-- Flag -->
        <col style="width: 240px;"> <!-- Team -->
        <col style="width: 65px;"> <!-- Has Dispatch/History -->
        <col style="width: 65px;" > <!-- Has FC mentions in Dispatch -->
        <col style="width: 65px;"> <!-- Updated Roster -->
        <col style="width: 65px;"> <!-- Article -->
        <col style="width: 65px;"> <!-- Poetry -->
        <col style="width: 65px;"> <!-- Flag & Banner -->
        <col style="width: 65px;"> <!-- Murder Mystery -->
        <col style="width: 65px;"> <!-- Quiz -->
        <col style="width: 65px;"> <!-- Scavenger Hunt -->
        <col style="width: 65px;"> <!-- Forest-Themed Connections Grid -->
        <col style="width: 65px;"> <!-- Host -->
        <col style="width: 65px;"> <!-- Eggs -->
        <col style="width: 65px;"> <!-- Extra -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- RP -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Events -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Bonus -->
        <col style="width: 65px;" class="bg-gradient-to-r from-blue-800/30 to-blue-800/60"> <!-- Results -->
        <col style="width: 30px;"> <!-- Total -->
      </colgroup>
      
      <thead class="bg-green-800 uppercase">
        <tr>
          <th rowspan="2" class="px-2 py-3 text-center border-b border-green-600 rounded-tl-xl" title="Position">°</th>
          <th rowspan="2" class="px-5 py-3 text-center border-b border-green-600"></th>
          <th rowspan="2" class="py-3 text-left border-b border-green-600">Team</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Roleplay</th>
          <th colspan="6" class="px-4 py-2 text-center border-b border-l border-green-600">Events</th>
          <th colspan="3" class="px-4 py-2 text-center border-b border-l border-green-600">Bonus</th>
          <th colspan="4" class="px-4 py-2 text-center border-b border-l border-green-600">Past</th>
          <th rowspan="2" class="px-3 py-3 text-center font-bold border-b border-l border-green-600 rounded-tr-xl">Pts</th>
        </tr>
        <tr>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="History Points - Roleplay, lore, dispatches">Hist</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="FC Mentions - Mentions in dispatches">FCM</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Updated Roster - Updated roster for the current edition">UR</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Article Points">AR</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Poetry Fantasia Points">PF</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Flag & Banner Points">F&B</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Murder Mystery Points">MM</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Quiz Contest Points">Quiz</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Scavenger Hunt Points">SH</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Forest-Themed Connections Grid Points">CG</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Host advantage points">Host</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Flag & Banner Points">Eggs</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Extra contribution points">Extra</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Roleplay Points - Previous editions with decay">RP</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Event Points - Previous editions with decay">Events</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Past Bonus Points - Previous editions with decay">Bonus</th>
          <th class="px-2 py-2 text-center font-medium border-b border-l border-green-600" title="Previous Tournament Results - Automatic calculation with decay">Results</th>
        </tr>
      </thead>
      
      <tbody class="text-center text-green-300">
        {rankedMembers.map((team, index) => {
          const historyPoints = getCurrentRoleplayPoints(team, 'dispatch');
          const fcMentions = getCurrentRoleplayPoints(team, 'fcm');
          const updatedRoster = getCurrentRoleplayPoints(team, 'roster');
          const articlePoints = getCurrentRoleplayPoints(team, 'article');
          const poetryPoints = getCurrentEventPoints(team, 'poetry');
          const flagBannerPoints = getCurrentEventPoints(team, 'fb');
          const murderMysteryPoints = getCurrentEventPoints(team, 'mm');
          const quizPoints = getCurrentEventPoints(team, 'quiz');
          const scavengerHuntPoints = getCurrentEventPoints(team, 'sh');
          const connectionsGridPoints = getCurrentEventPoints(team, 'cg');
          const hostPoints = getCurrentBonusPoints(team, 'host');
          const eggsPoints = getCurrentBonusPoints(team, 'eggs');
          const extraPoints = getCurrentBonusPoints(team, 'extra');

          return (
          <tr class="border-b border-green-700 hover:bg-green-900/30 transition duration-150">
            <td class="py-2">{index + 1}</td>
            <td class="py-1 sticky left-0 bg-green-800 xl:bg-transparent">
              <Image 
                src={team.flag || "/placeholder.svg"} 
                alt={team.name} 
                quality={20} 
                format="webp"
                width={50} 
                class="h-4 w-auto object-cover rounded inline-block" 
              />
            </td>
            <td class="py-2 text-left overflow-hidden text-ellipsis">
              <a 
                href={`/members/${team.slug}`} 
                class="font-semibold hover:underline text-white overflow-hidden text-ellipsis ml-2" 
                title={team.name}
              >
                {team.name}
              </a>
            </td>
            
            <td class="px-2 py-2" title={`History Points: ${historyPoints}`}>
              {historyPoints}
            </td>
            <td class="px-2 py-2" title={`FC Mentions: ${fcMentions}`}>
              {fcMentions}
            </td>
            <td class="px-2 py-2" title={`Updated Roster: ${updatedRoster}`}>
              {updatedRoster}
            </td>
            <td class="px-2 py-2" title={`Article Points: ${articlePoints}`}>
              {articlePoints}
            </td>
            <td class="px-2 py-2" title={`Poetry Contest Points: ${poetryPoints}`}>
              {poetryPoints}
            </td>
            <td class="px-2 py-2" title={`Flag & Banner Points: ${flagBannerPoints}`}>
              {flagBannerPoints}
            </td>
            <td class="px-2 py-2" title={`Murder Mystery Points: ${murderMysteryPoints}`}>
              {murderMysteryPoints}
            </td>
            <td class="px-2 py-2" title={`Quiz Points: ${quizPoints}`}>
              {quizPoints}
            </td>
            <td class="px-2 py-2" title={`Scavenger Hunt Points: ${scavengerHuntPoints}`}>
              {scavengerHuntPoints}
            </td>
            <td class="px-2 py-2" title={`Connections Grid Points: ${connectionsGridPoints}`}>
              {connectionsGridPoints}
            </td>
            <td class="px-2 py-2" title={`Host Bonus: ${hostPoints}`}>
              {hostPoints}
            </td>
            <td class="px-2 py-2" title={`Eggs Points: ${eggsPoints}`}>
              {eggsPoints}
            </td>
            <td class="px-2 py-2" title={`Extra Bonus: ${extraPoints}`}>
              {extraPoints}
            </td>
            <td class="px-2 py-2" title={`Past Roleplay Points: ${team.scores.pastRoleplay}`}>
              {team.scores.pastRoleplay}
            </td>
            <td class="px-2 py-2" title={`Past Event Points: ${team.scores.pastEventPoints}`}>
              {team.scores.pastEventPoints}
            </td>
            <td class="px-2 py-2" title={`Past Bonus Points: ${team.scores.pastBonus}`}>
              {team.scores.pastBonus}
            </td>
            <td class="px-2 py-2" title={`Tournament Decay Points: ${team.scores.tournamentDecayPoints}`}>
              {team.scores.tournamentDecayPoints}
            </td>
            <td class={`px-4 py-2 ${getTotalColorClass(team.totalScore)}`}>
              {team.totalScore}
            </td>
          </tr>
        )})}
        
        {rankedMembers.length === 0 && (
          <tr>
            <td colspan="10" class="text-center py-4 text-green-500">
              No verified members found.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>
  
  <!-- INFORMACIÓN ADICIONAL CON EDICIÓN DINÁMICA -->
  <div class="max-w-7xl mx-auto mt-6 text-center">
    <div class="bg-green-900/20 rounded-lg p-4">
      <p class="text-sm text-green-300 mb-2">
        <strong>Top 24</strong> teams qualify directly for <strong>Forest Cup {nextEdition}</strong>
      </p>
      <p class="text-xs text-green-400">
        Points are calculated automatically from tournament results and events. 
      </p>
      <p class="text-xs text-green-500 mt-2">
        Higher ranking = Better group stage seeding + Direct qualification advantage
      </p>
    </div>
  </div>
</div>
