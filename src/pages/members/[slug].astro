---
import { type CollectionEntry } from 'astro:content';
import { getTournaments, getMatches, getMembers, getArticles } from '@lib/collections';
import { Image } from 'astro:assets';
import { getMemberRank, getMemberByName } from '@lib/memberUtils';
import { getMemberTotalScore } from '@lib/rankingUtils';
import { getAchievementsForMember } from '@lib/achievements/dynamics/index';
import App from '@layouts/App.astro';
import ScorersTable from '@components/tournaments/ScorersTable.astro';
import MatchCard from '@components/matches/MatchCard.astro';
import MatchCardDetailed from '@components/matches/MatchCardDetailed.astro';
import RecordsAndStats from '@components/members/RecordsAndStats.astro';
import TournamentParticipationTable from '@components/members/TournamentParticipationTable.astro';
import MemberHero from '@components/members/MemberHero.astro';
import { CURRENT_TOURNAMENT_ID } from '@lib/tournamentUtils';
import { getArticlesByTags } from '@lib/articleUtils';
import RelatedNews from '@components/articles/RelatedNews.astro';

export const prerender = true;

type MemberType = CollectionEntry<'members'>;

interface Props {
  member: MemberType;
}

export async function getStaticPaths() {
  const members = await getMembers();
  return members.map((member: MemberType) => ({
    params: { slug: member.slug },
    props: { member },
  }));
}

// --- Parámetro de URL y Miembro Actual ---
const { member } = Astro.props;

if (!member) {
  return Astro.redirect('/404');
}

const { Content } = await member.render(); // Obtener el componente para renderizar el Markdown
const memberData = member.data;

const matches = await getMatches();
const tournaments = await getTournaments();
const members = await getMembers();

// Filtra partidos jugados donde el miembro actual es team1 o team2
const playedMatches = matches
  .filter(match => match.data.status === 'played' && (match.data.team1 === memberData.name || match.data.team2 === memberData.name))
  .map(match => {
    const score1 = match.data.goals?.filter(g => g.team === match.data.team1).length ?? 0;
    const score2 = match.data.goals?.filter(g => g.team === match.data.team2).length ?? 0;
    let penaltyScore1 = 0;
    let penaltyScore2 = 0;
    let penaltiesInfo = '';
    if (match.data.penalties && match.data.penalties.length > 0) {
      penaltyScore1 = match.data.penalties.filter(p => p.team === match.data.team1 && p.scored).length;
      penaltyScore2 = match.data.penalties.filter(p => p.team === match.data.team2 && p.scored).length;
      penaltiesInfo = `(${penaltyScore1}-${penaltyScore2} p)`;
    }

    return {
      ...match,
      score1,
      score2,
      penaltiesInfo,
    };
  });

playedMatches.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// --- Lógica para Head-to-Head (H2H) ---
interface H2HStats {
  difference: number;
  played: number;
  wins: number;
  draws: number;
  losses: number;
  goalsFor: number;
  goalsAgainst: number;
  opponentData: CollectionEntry<'members'> | null;
}

// Inicializar y precomputar estadísticas H2H
const h2hStats: Record<string, H2HStats> = {};

for (const match of playedMatches) {
  const opponentName = match.data.team1 === memberData.name ? match.data.team2 : match.data.team1;
  if (!opponentName) continue;
  if (!h2hStats[opponentName]) {
    h2hStats[opponentName] = {
      difference: 0,
      played: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsFor: 0,
      goalsAgainst: 0,
      opponentData: await getMemberByName(opponentName),
    };
  }

  h2hStats[opponentName].played++;
  let memberScore = 0;
  let opponentScore = 0;

  if (match.data.team1 === memberData.name) {
    memberScore = match.score1;
    opponentScore = match.score2;
  } else {
    memberScore = match.score2;
    opponentScore = match.score1;
  }

  h2hStats[opponentName].goalsFor += memberScore;
  h2hStats[opponentName].goalsAgainst += opponentScore;

  if (memberScore > opponentScore) {
    h2hStats[opponentName].wins++;
    h2hStats[opponentName].difference++;
  } else if (memberScore < opponentScore) {
    h2hStats[opponentName].losses++;
    h2hStats[opponentName].difference--;
  } else {
    h2hStats[opponentName].draws++;
  }
}

const memberRank = getMemberRank(member, CURRENT_TOURNAMENT_ID);
const memberTotalScoreResult = await getMemberTotalScore(member, CURRENT_TOURNAMENT_ID);
const memberTotalScore = memberTotalScoreResult.totalScore;
const titles = tournaments
  .filter(t => t.data.champion === memberData.name)
  .map(t => ({ year: t.data.edition }));

const hasContent = member?.body && member.body.trim() !== '';
const achievements = [];
const articles = await getArticles();
const filterTags = [member.slug];
const filteredArticles = getArticlesByTags(articles, filterTags);
---

<App title={`FFC - ${memberData.name}`}>
  <div class="md:container m-auto p-4 py-8">
    <MemberHero memberData={memberData} ranking={memberRank} points={memberTotalScore} titles={titles} achievements={achievements} />

    <TournamentParticipationTable 
      member={member} 
      matches={matches} 
      type="forest-cup" 
    />
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-green-950/80 shadow-lg rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4 text-white border-b pb-2 border-green-600">Last Matches Played</h2>
        {playedMatches.length > 0 ? (
          <div class="flex flex-col gap-4">
            {playedMatches.slice(0, 8).map((match) => (
              <MatchCardDetailed match={match} />
            ))}
          </div>
        ) : (
          <p class="text-gray-400 italic">This National Team hasn't played any matches yet.</p>
        )}
      </div>

      <div class="bg-green-950/80 shadow-lg rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4 text-white border-b pb-2 border-green-600">Historic Head-to-Head</h2>
        {Object.keys(h2hStats).length > 0 ? (
          <div class="overflow-x-auto pb-0">
            <table class="min-w-full border border-green-700 overflow-hidden rounded-lg text-sm">
              <thead>
                <tr class="bg-green-800 text-white">
                  <th scope="col" class="px-4 py-2 text-left tracking-wider">Opponent</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Difference">Dif</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Matches Played">Pld</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Wins">W</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Draws">D</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Losses">L</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Goals for">GF</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Goals against">GA</th>
                  <th scope="col" class="px-1 py-2 text-center tracking-wider" title="Goal difference">GD</th>
                </tr>
              </thead>
              <tbody>
                {Object.entries(h2hStats)
                  .sort(([, a], [, b]) => {
                    if (b.played !== a.played) return b.played - a.played;
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    const diffA = a.goalsFor - a.goalsAgainst;
                    const diffB = b.goalsFor - b.goalsAgainst;
                    if (diffB !== diffA) return diffB - diffA;
                    return b.goalsFor - a.goalsFor;
                  })
                  .map(([opponentName, stats]) => (
                    <tr key={opponentName} class="border-b border-green-700 hover:bg-green-900/30 transition duration-150">
                      <td class="px-4 py-2 whitespace-nowrap font-medium text-white">
                        <a href={`/members/${stats.opponentData?.slug || '#'}`} class="flex items-center gap-2 hover:underline truncate">
                          <Image
                            src={stats.opponentData?.data.flagPath || '/images/tournaments/default-flag.png'}
                            alt={opponentName}
                            class="w-6 h-4 object-cover rounded"
                            height={36}
                            loading="lazy"
                            quality={10}
                            format="webp"
                          />
                          {opponentName}
                        </a>
                      </td>
                      <td class={`px-1 py-2 whitespace-nowrap text-center text-green-200 font-bold
                        ${stats.difference > 0 ? 'text-green-400' : stats.difference < 0 ? 'text-red-400' : 'text-gray-300'}`}>
                        {stats.difference === 0 ? '-' : stats.difference > 0 ? `+${stats.difference}` : stats.difference}
                      </td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-green-200">{stats.played}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-green-400">{stats.wins}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-yellow-400">{stats.draws}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-red-400">{stats.losses}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-green-200">{stats.goalsFor}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-green-200">{stats.goalsAgainst}</td>
                      <td class="px-1 py-2 whitespace-nowrap text-center text-green-200">{stats.goalsFor - stats.goalsAgainst}</td>
                    </tr>
                  ))}
              </tbody>
            </table>
          </div>
        ) : (
          <p class="text-gray-400 italic">There are no stats to show for this National Team</p>
        )}
        <section class="flex justify-center items-center flex-col">
          <ScorersTable members={members.filter(m => m.slug === member.slug)} matches={playedMatches} />
        </section>
      </div>
    </div>
    <RecordsAndStats member={member} matches={playedMatches} />
    {filteredArticles.length > 0 && (
      <RelatedNews articles={filteredArticles} max={4} />
    )}
  </div>
</App>